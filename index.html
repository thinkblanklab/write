<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë”°ë¼ì“°ê¸° ì›Œí¬ì‹œíŠ¸ ìƒì„±ê¸° (MVP)</title>
         <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap" rel="stylesheet">

  <style>
    :root { --border:#e5e7eb; --bg:#fafafa; --text:#111827; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      color:var(--text);
      background:var(--bg);
    }
    .wrap {
      max-width: 1100px; margin: 20px auto; padding: 16px;
      display:grid; gap:16px; grid-template-columns: 360px 1fr;
    }
    .card {
      background:#fff; border:1px solid var(--border);
      border-radius:14px; padding:14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.06);
    }
    h1 { font-size:18px; margin:0 0 10px; }
    label { display:block; font-size:12px; margin:12px 0 6px; color:#374151; }

    textarea, select, input[type="number"] {
      width:100%; box-sizing:border-box;
      border:1px solid var(--border); border-radius:10px; padding:10px;
      font-size:14px; background:#fff;
    }
    textarea { min-height: 84px; resize: vertical; line-height: 1.6;  /* âœ¨ ì´ ì¤„ì„ ì¶”ê°€í•˜ì„¸ìš” (ì¤„ ê°„ê²©ì„ 1.6ë°°ë¡œ ë„“í˜) */}
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    .btns {
      display: flex;
      gap: 12px;
      margin-top: 14px;
      flex-wrap: nowrap;
      justify-content: flex-start; /* center ë¡œ ë°”ê¾¸ë©´ ì¤‘ì•™ì •ë ¬ */
    }

/* [ìŠ¤íƒ€ì¼ ì¶”ê°€] í”„ë¦¬ì…‹ ì¹© ë²„íŠ¼ */
    .preset-btns { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
    .chip {
      background: #f3f4f6; border: 1px solid #d1d5db; color: #4b5563;
      padding: 6px 12px; border-radius: 99px; font-size: 12px; cursor: pointer;
      transition: all 0.2s;
    }
    .chip:hover { background: #e5e7eb; color: #111827; }
.chip.active {
  background: #111827;
  color: #ffffff;
  border-color: #111827;
}
    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      min-height: 40px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: -0.2px;
      white-space: nowrap;
      transition: all 0.15s ease;
    }

    button.primary {
      background: #111827;
      color: #ffffff;
      border: none;
      box-shadow: 0 4px 12px rgba(17, 24, 39, 0.25);
    }
    button.primary:hover { background: #0f172a; transform: translateY(-1px); }

    button.secondary {
      background: #ffffff;
      color: #111827;
      border: 1px solid #e5e7eb;
    }
    button.secondary:hover { background: #f9fafb; }

    .hint-small { margin-top: 6px; font-size: 12px; color: #6b7280; }

    .hint { font-size:12px; color:#6b7280; line-height:1.45; margin-top:8px; }
    .small { font-size:11px; color:#6b7280; margin-top:6px; }
    .canvasWrap { display:flex; justify-content:center; align-items:flex-start; padding:10px; }
    canvas { width:100%; max-width: 680px; height:auto; border-radius:14px; border:1px solid var(--border); background:#fff; }
    .badge { display:inline-block; font-size:11px; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; margin-left:6px; }
  
  @media (max-width: 768px) {
  .wrap { grid-template-columns: 1fr; }
  .canvasWrap canvas { width: 100%; }
}
  
/* ìš°ë¦¬ ì•„ì´ ë¬¸ì¥ ì €ì¥ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
.kidBox { margin-top:10px; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fafafa; }
.kidBoxTitle { font-size:12px; font-weight:700; color:#374151; margin-bottom:8px; }
.kidBoxBtns { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:6px; }
  
/* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ (ì ê¹ ë–´ë‹¤ ì‚¬ë¼ì§€ëŠ” ì•Œë¦¼) */
.toast-msg {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(17, 24, 39, 0.9); /* ì§„í•œ ë‚¨ìƒ‰ ë°˜íˆ¬ëª… */
  color: #fff;
  padding: 10px 24px;
  border-radius: 99px;
  font-size: 14px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 9999;
  animation: fadeUp 0.3s ease-out;
}
@keyframes fadeUp {
  from { opacity: 0; transform: translate(-50%, 20px); }
  to { opacity: 1; transform: translate(-50%, 0); }
}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ë”°ë¼ì“°ê¸° ì›Œí¬ì‹œíŠ¸ ìƒì„±ê¸° <span class="badge">MVP</span></h1>

      <label>ë¬¸êµ¬ ì…ë ¥ (ì—¬ëŸ¬ ì¤„ ê°€ëŠ¥)</label>
      <div class="preset-btns">
        <button class="chip" onclick="setPreset('funny')">ğŸ’© ì›ƒìŒ í­íƒ„</button>
        <button class="chip" onclick="setPreset('food')">ğŸ¡ ë§›ìˆëŠ” ê±°</button>
        <button class="chip" onclick="setPreset('wish')">ğŸ™ í˜„ì‹¤ ì†Œì›</button>
        <button class="chip" onclick="setPreset('youtube')">ğŸ¬ ë‚˜ë„ ìœ íŠœë²„</button>
        <button class="chip" data-preset="kpop" onclick="setPreset('kpop')">ğŸ¤ ì•„ì´ëŒ ë°ë·”</button>
        <button class="chip" data-preset="power" onclick="setPreset('power')">ğŸ’ª ìì¡´ê° ì‘¥ì‘¥</button>
      </div>
      <div class="hint-text" style="font-size:12px; color:#6b7280; margin-bottom:4px;">
        ğŸ‘‡ ì§ì ‘ ì“°ê±°ë‚˜, ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!
      </div> <textarea id="text" placeholder="Tip: ì•„ì´ ì´ë¦„, í¬ì¼“ëª¬ ì´ë¦„, ì¢‹ì•„í•˜ëŠ” ë…¸ë˜ ê°€ì‚¬ë¥¼ ì ì–´ì£¼ì„¸ìš”."></textarea>
<div class="kidBox">
  <div class="kidBoxTitle">â­ ìš°ë¦¬ ì•„ì´ ë¬¸ì¥ (ë‚˜ë§Œì˜ ì €ì¥ì†Œ)</div>
  <div class="kidBoxBtns">
    <button class="chip" id="kidSaveBtn" onclick="saveKidPreset()">ì§€ê¸ˆ ë¬¸ì¥ ì €ì¥</button>
    <button class="chip" id="kidLoadBtn" onclick="loadKidPreset()">ì €ì¥í•œ ë¬¸ì¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>
  <div class="hint-small">ì§€ê¸ˆ ì“°ëŠ” ê¸°ê¸°(ë¸Œë¼ìš°ì €)ì—ë§Œ ì €ì¥ë¼ìš”!</div>
</div>


      <label>ê¸€ì”¨ì²´ ì„ íƒ</label>
      <select id="font">
        <option value='"Malgun Gothic","ë§‘ì€ ê³ ë”•","Noto Sans KR",sans-serif'>ê³ ë”•ì²´(ê¸°ë³¸)</option>
        <option value='"Batang","ë°”íƒ•",serif'>ëª…ì¡°ì²´(ë°”íƒ•)</option>
        <option value='"Gungsuh","ê¶ì„œ",serif'>ê¶ì„œì²´</option>
        <option value='"Nanum Pen Script", cursive'>ë‚˜ëˆ” ì†ê¸€ì”¨ íœ</option>
      </select>

      <div class="row">
        <div>
          <label>ê¸€ì í¬ê¸°</label>
          <input id="fontSize" type="number" min="24" max="120" step="1" value="64" />
        </div>
        <div>
          <label>ì¤„ ìˆ˜</label>
          <input id="lines" type="number" min="3" max="20" step="1" value="10" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>ë”°ë¼ì“°ê¸° ìŠ¤íƒ€ì¼</label>
          <select id="traceStyle">
            <option value="solid">ì—°í•œ ì‹¤ì„ (ì¶”ì²œ)</option>
            <option value="dashed">íšŒìƒ‰ ì ì„ (ê³ ê¸‰)</option>
          </select>
          <label>ì‹¤ì„  ì§„í•˜ê¸° (í”„ë¦°íŠ¸ìš©)</label>
<input
  id="alpha"
  type="range"
  min="0.15"
  max="0.80"
  step="0.05"
  value="0.35"
/>
<div class="hint-small">ì—°í•˜ê²Œ â†” ì§„í•˜ê²Œ (í”„ë¦°í„°ë§ˆë‹¤ ì¡°ì ˆí•˜ì„¸ìš”)</div>

        </div>
        <div>
          <label>ë°°ê²½ ì„ íƒ</label>
          <select id="bg">
            <option value="kakdugi">í•œê¸€ ê¹ë‘ê¸°</option>
            <option value="fourline">ì˜ì–´ 4ì„ </option>
            <option value="blank">ë¯¼ì</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>ìƒë‹¨ ì œëª©</label>
          <select id="titleMode">
            <option value="none">ì—†ìŒ</option>
            <option value="date">ì˜¤ëŠ˜ ë‚ ì§œ ë„£ê¸°</option>
            <option value="name">ì´ë¦„ ì¹¸ í‘œì‹œ</option>
            <option value="date+name">ë‚ ì§œ + ì´ë¦„</option>
          </select>
        </div>
        <div>
          <label>ì—¬ë°±(í”„ë¦°íŠ¸ ì•ˆì „ì˜ì—­)</label>
          <input id="margin" type="number" min="24" max="120" step="1" value="64" />
        </div>
      </div>

      <div class="btns">
        <button id="pdf" class="primary">PDF ì¸ì‡„ â­</button>
        <button id="download" class="secondary">PNG ì €ì¥</button>
      </div>
      <p class="hint-small">PDFëŠ” A4 ì¸ì‡„ìš©ìœ¼ë¡œ ê°€ì¥ ê¹”ë”í•´ìš”</p>

      <div class="hint">
        - ì…ë ¥/ì˜µì…˜ì„ ë°”ê¾¸ë©´ ìë™ìœ¼ë¡œ ì˜¤ë¥¸ìª½ ë¯¸ë¦¬ë³´ê¸°ê°€ ê°±ì‹ ë©ë‹ˆë‹¤.<br/>
        - ì¶œë ¥ì€ PDF ì¸ì‡„(CTRL+P â†’ PDFë¡œ ì €ì¥) ë˜ëŠ” PNG ì €ì¥ í›„ ì¸ì‡„.<br/>
        - ì ì„ ì€ â€œìœ¤ê³½ ì ì„ â€ ëŠë‚Œ(ê°€ì¥ êµì¬ì— ê°€ê¹Œìš´ ë°©ì‹)ìœ¼ë¡œ êµ¬í˜„ë©ë‹ˆë‹¤.
      </div>
      <div class="small">Tip: ì•„ì´ê°€ ì¢‹ì•„í•˜ëŠ” ë‹¨ì–´/ì´ë¦„/ê°€ì‚¬ í•œ ì¤„ë§Œ ë„£ì–´ë„ íš¨ê³¼ ì¢‹ì•„ìš”.</div>
    </div>

    <div class="card">
      <div class="canvasWrap">
        <!-- A4 ë¹„ìœ¨: 2480 x 3508 (300dpi) ëŒ€ì‹ , ê°€ë³ê²Œ 1240 x 1754(150dpi) -->
        <canvas id="paper" width="1240" height="1754"></canvas>
      </div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById("paper");
  const ctx = canvas.getContext("2d");

  const els = {
    pdf: document.getElementById("pdf"),
    download: document.getElementById("download"),
    text: document.getElementById("text"),
    font: document.getElementById("font"),
    fontSize: document.getElementById("fontSize"),
    lines: document.getElementById("lines"),
    traceStyle: document.getElementById("traceStyle"),
    bg: document.getElementById("bg"),
    titleMode: document.getElementById("titleMode"),
    margin: document.getElementById("margin"),
    alpha: document.getElementById("alpha"),
  };

  /* 1. í”„ë¦¬ì…‹ ë°ì´í„° (ì¬ë¯¸ìˆëŠ” ë¬¸êµ¬ë“¤) */
 /* 1. í”„ë¦¬ì…‹ ë°ì´í„° (ì¬ë¯¸ìˆëŠ” ë¬¸êµ¬ë“¤) */
  const presets = {
    funny: "ë°©ê·€ ì†Œë¦¬ê°€ ë½• í•˜ê³  ë‚¬ë‹¤\në‚´ ë°œ ëƒ„ìƒˆëŠ” ì¹˜ì¦ˆ ëƒ„ìƒˆ\nì½”ë”±ì§€ëŠ” ë¨¹ìœ¼ë©´ ì§­ì§¤í•´\nì„¸ìƒì—ì„œ ì œì¼ ì›ƒê¸´ ì¶¤\nê°œêµ¬ë¦¬ ë’·ë‹¤ë¦¬ ì‘¥",
    food: "ë§ˆë¼íƒ•ì— ë¶„ëª¨ì ì¶”ê°€ìš”\nê²‰ë°”ì†ì´‰ ì–‘ë… ì¹˜í‚¨\níƒ•í›„ë£¨ëŠ” ì„¤íƒ•ì´ ë°”ì‚¬ì‚­\ní¸ì˜ì  ì»µë¼ë©´ì´ ìµœê³ ì•¼\nì‹œì›í•œ ì•„ì´ìŠ¤í¬ë¦¼ ì£¼ì„¸ìš”",
    wish: "ì˜¤ëŠ˜ ìˆ™ì œëŠ” ì—†ëŠ” ê±¸ë¡œ í•´ìš”\nìš©ëˆ ì˜¬ë ¤ì£¼ì„¸ìš” ì—„ë§ˆ\nê²Œì„ 30ë¶„ë§Œ ë” í• ë˜ìš”\ní•™ì› ì•ˆ ê°€ê³  ë†€ê³  ì‹¶ë‹¤\në‚˜ëŠ” ì•„ë¬´ ìƒê°ì´ ì—†ë‹¤",
    // â–¼â–¼â–¼ ìš”ê¸° ì•„ë˜ ì¤„ ëì— ì½¤ë§ˆ(,)ê°€ ê¼­ ìˆì–´ì•¼ í•´ìš”! â–¼â–¼â–¼
    youtube: "êµ¬ë…ê³¼ ì¢‹ì•„ìš” ëˆŒëŸ¬ì£¼ì„¸ìš”\nì•Œë¦¼ ì„¤ì •ê¹Œì§€ ë”¸ë‘ë”¸ë‘\nì•ˆë…•í•˜ì„¸ìš” ì—¬ëŸ¬ë¶„ TVì…ë‹ˆë‹¤\nì˜¤ëŠ˜ì€ ë¨¹ë°©ì„ ì°ì–´ë³¼ê²Œìš”\nì¬ë°Œì—ˆë‹¤ë©´ ëŒ“ê¸€ ë‹¬ì•„ì¤˜",
    kpop: "ë¬´ëŒ€ ìœ„ ì£¼ì¸ê³µì€ ë°”ë¡œ ë‚˜\në°˜ì§ë°˜ì§ ë¹›ë‚˜ëŠ” ì¡°ëª…\níŒ¬ë“¤ì˜ í•¨ì„± ì†Œë¦¬ê°€ ë“¤ë ¤\në©‹ì§„ ì¶¤ì„ ë³´ì—¬ì¤„ê²Œìš”\nê¿ˆì„ í–¥í•´ ë‹¬ë ¤ê°€ì",
    power: "ë‚˜ëŠ” ì„¸ìƒì—ì„œ ê°€ì¥ ì†Œì¤‘í•´\nì‹¤ìˆ˜í•´ë„ ê´œì°®ì•„ ë‹¤ì‹œ í•´ë´\në§¤ì¼ë§¤ì¼ ë” ë©‹ì ¸ì§ˆ ê±°ì•¼\në‚˜ëŠ” ë‚˜ë¥¼ ì‚¬ë‘í•´ìš”\ní•  ìˆ˜ ìˆë‹¤ê³  ë¯¿ì–´ë´"
  };

/* [ì¶”ê°€ ê¸°ëŠ¥] ìš°ë¦¬ ì•„ì´ ë¬¸ì¥ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° (í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì ìš©) */
  const KID_KEY = "kid_preset_text_v1";

  // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ë„ìš°ê¸° í•¨ìˆ˜ (2ì´ˆ ë’¤ ì‚¬ë¼ì§)
  function showToast(message) {
    const div = document.createElement("div");
    div.className = "toast-msg";
    div.innerText = message;
    document.body.appendChild(div);
    
    // 2ì´ˆ í›„ì— ì„œì„œíˆ ì‚¬ë¼ì§€ê²Œ í•˜ê¸°
    setTimeout(() => {
      div.style.transition = "opacity 0.5s";
      div.style.opacity = "0";
      setTimeout(() => div.remove(), 500); // ì™„ì „íˆ ì‚­ì œ
    }, 2000);
  }

  // ì €ì¥í•˜ê¸° ê¸°ëŠ¥
  window.saveKidPreset = () => {
    const v = (els.text.value || "").trim();
    if(!v){
      showToast("ë¨¼ì € ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! ğŸ˜…"); // ê²½ê³ ë„ ë¶€ë“œëŸ½ê²Œ
      return;
    }
    localStorage.setItem(KID_KEY, v);
    showToast("â­ ì €ì¥ ì™„ë£Œ! (ë¸Œë¼ìš°ì €ì— ì €ì¥ë¨)"); // ì„±ê³µ ì•Œë¦¼
  };

  // ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥
  window.loadKidPreset = () => {
    const saved = localStorage.getItem(KID_KEY);
    if(!saved || !saved.trim()){
      showToast("ì•„ì§ ì €ì¥ëœ ë¬¸ì¥ì´ ì—†ì–´ìš” ğŸ¥²");
      return;
    }
    els.text.value = saved;
    render(); 
    showToast("ğŸ“‚ ì €ì¥í–ˆë˜ ë¬¸ì¥ì„ ë¶ˆëŸ¬ì™”ì–´ìš”!");
  };

  /* 2. ë²„íŠ¼ í´ë¦­ ê¸°ëŠ¥ (ìƒ‰ìƒ ë³€ê²½ + í…ìŠ¤íŠ¸ ì…ë ¥) */
  window.setPreset = (type) => {
    // í…ìŠ¤íŠ¸ ë³€ê²½
    els.text.value = presets[type];
    
    // ë²„íŠ¼ ìƒ‰ìƒ í™œì„±í™” (active í´ë˜ìŠ¤)
    document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
    // í´ë¦­ëœ ë²„íŠ¼ì—ë§Œ ìƒ‰ì¹ í•˜ê¸° (eventê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰)
    if(window.event) window.event.target.classList.add("active");

    render(); // í™”ë©´ ê°±ì‹ 
  };

  function todayKR() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    return `${y}.${m}.${da}`;
  }

  function clearPaper() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  function drawHeader(margin) {
    const mode = els.titleMode.value;
    if (mode === "none") return 0;

    const headerH = 90;
    ctx.save();
    ctx.strokeStyle = "#e5e7eb";
    ctx.lineWidth = 2;
    ctx.strokeRect(margin, margin, canvas.width - margin * 2, headerH);

    ctx.fillStyle = "#111827";
    ctx.font = `600 28px ${els.font.value}`;
    ctx.textBaseline = "middle";

    let leftText = "";
    let rightText = "";

    if (mode.includes("date")) leftText = `ë‚ ì§œ: ${todayKR()}`;
    if (mode.includes("name")) rightText = "ì´ë¦„: ____________________";

    if (leftText) ctx.fillText(leftText, margin + 18, margin + headerH / 2);
    if (rightText) {
      const w = ctx.measureText(rightText).width;
      ctx.fillText(rightText, canvas.width - margin - 18 - w, margin + headerH / 2);
    }

    ctx.restore();
    return headerH + 26;
  }

  function drawBackground(type, margin, topOffset, lineGap) {
    ctx.save();
    ctx.strokeStyle = "#e5e7eb";
    ctx.lineWidth = 2;

    const left = margin;
    const right = canvas.width - margin;
    const top = margin + topOffset;
    const bottom = canvas.height - margin;

    // ë°”ê¹¥ í…Œë‘ë¦¬
    ctx.strokeRect(left, top, right - left, bottom - top);

    if (type === "blank") {
      ctx.strokeStyle = "#f1f5f9";
      for (let i = 0; i < Number(els.lines.value); i++) {
        const y = top + (i + 1) * lineGap;
        ctx.beginPath();
        ctx.moveTo(left, y);
        ctx.lineTo(right, y);
        ctx.stroke();
      }
      ctx.restore();
      return;
    }

    if (type === "kakdugi") {
      const cell = Math.max(52, Math.floor(lineGap * 0.9));
      ctx.strokeStyle = "#eef2f7";
      ctx.lineWidth = 2;

      for (let i = 0; i < Number(els.lines.value); i++) {
        const rowTop = top + i * lineGap;
        const rowMid = rowTop + lineGap * 0.5;

        // ì¤„ ê¸°ì¤€ì„ 
        ctx.beginPath();
        ctx.moveTo(left, rowTop + lineGap);
        ctx.lineTo(right, rowTop + lineGap);
        ctx.stroke();

        // ê¹ë‘ê¸° ë°•ìŠ¤ë“¤
        let x = left + 18;
        while (x + cell <= right - 18) {
          const y = rowMid - cell / 2;
          ctx.strokeRect(x, y, cell, cell);
          x += cell + 14;
        }
      }
      ctx.restore();
      return;
    }

    if (type === "fourline") {
      for (let i = 0; i < Number(els.lines.value); i++) {
        const capY  = top + i * lineGap + lineGap * 0.28;
        const midY  = top + i * lineGap + lineGap * 0.53;
        const baseY = top + i * lineGap + lineGap * 0.78;
        const lowY  = top + i * lineGap + lineGap * 0.90;

        ctx.save();
        ctx.lineWidth = 2;
        ctx.strokeStyle = "#e5e7eb";
        [capY, midY, lowY].forEach(y => {
          ctx.beginPath();
          ctx.moveTo(left + 18, y);
          ctx.lineTo(right - 18, y);
          ctx.stroke();
        });

        ctx.strokeStyle = "#cbd5e1";
        ctx.beginPath();
        ctx.moveTo(left + 18, baseY);
        ctx.lineTo(right - 18, baseY);
        ctx.stroke();
        ctx.restore();
      }
      ctx.restore();
      return;
    }

    ctx.restore();
  }

  function wrapLines(inputText) {
    const raw = inputText.split("\n").map(s => s.trim()).filter(Boolean);
    return raw.length ? raw : [" "];
  }

  function drawTracingText(margin, topOffset, lineGap) {
    const linesCount = Number(els.lines.value);
    const baseSize = Number(els.fontSize.value);
    const fontFamily = els.font.value;
    const style = els.traceStyle.value;

    const phrases = wrapLines(els.text.value);

    const left = margin + 36;
    const right = canvas.width - margin - 36;

    ctx.save();
    ctx.textBaseline = "alphabetic";

    for (let i = 0; i < linesCount; i++) {
      const phrase = phrases[i % phrases.length];

      // ê° ì¤„ì˜ ê¸°ì¤€ y
      let y = margin + topOffset + (i + 1) * lineGap - lineGap * 0.22;
      if (els.bg.value === "fourline") {
        y = margin + topOffset + i * lineGap + lineGap * 0.78;
      }

      ctx.font = `${Math.floor(baseSize)}px ${fontFamily}`;
      const w = ctx.measureText(phrase).width;
      const maxW = right - left;
      const scale = w > maxW ? (maxW / w) : 1;

      const size = Math.max(14, Math.floor(baseSize * scale));
      const fontStr = `${size}px ${fontFamily}`;

      ctx.save();
      ctx.font = fontStr;

      if (style === "dashed") {
        ctx.setLineDash([Math.max(6, size / 10), Math.max(6, size / 10)]);
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.strokeStyle = "#9ca3af";
        ctx.lineWidth = Math.max(2, Math.floor(size / 22));
        ctx.strokeText(phrase, left, y);
      } else {
        ctx.setLineDash([]);
        ctx.fillStyle = "#9ca3af";
        const alpha = Number(els.alpha?.value || 0.35);
        ctx.globalAlpha = alpha;
        ctx.fillText(phrase, left, y);

        ctx.globalAlpha = 0.25;
        ctx.strokeStyle = "#9ca3af";
        ctx.lineWidth = Math.max(1, Math.floor(size / 40));
        ctx.strokeText(phrase, left, y);
      }
      ctx.restore();
    }
    ctx.restore();
  }

  function render() {
    const margin = Number(els.margin.value);
    const linesCount = Number(els.lines.value);
    clearPaper();
    const headerOffset = drawHeader(margin);
    const topOffset = headerOffset + 18;
    const usableH = canvas.height - (margin + topOffset) - margin;
    const lineGap = Math.floor(usableH / linesCount);
    drawBackground(els.bg.value, margin, topOffset, lineGap);
    drawTracingText(margin, topOffset, lineGap);
  }

  function downloadPNG() {
    const name = `worksheet_${todayKR().replaceAll(".","-")}.png`;
    const link = document.createElement("a");
    link.download = name;
    link.href = canvas.toDataURL("image/png");
    link.click();
  }

  function saveAsPDF() {
    const win = window.open("", "_blank");
    win.document.write(`
      <html>
      <head>
        <title>ë”°ë¼ì“°ê¸° ì›Œí¬ì‹œíŠ¸ PDF</title>
        <style>
          @page { size: A4; margin: 0; }
          body { margin: 0; display:flex; justify-content:center; align-items:center; }
          img { width: 210mm; height: 297mm; }
        </style>
      </head>
      <body>
        <img src="${canvas.toDataURL("image/png")}" />
      </body>
      </html>
    `);
    win.document.close();
    win.onload = () => { win.focus(); win.print(); };
  }

  // ì´ë²¤íŠ¸
  els.download.addEventListener("click", downloadPNG);
  els.pdf.addEventListener("click", saveAsPDF);

  ["text","font","fontSize","lines","traceStyle","bg","titleMode","margin", "alpha"].forEach(id => {
    els[id].addEventListener("input", render);
    els[id].addEventListener("change", render);
  });

// [ìˆ˜ì •ë¨] í°íŠ¸ ë³€ê²½ ê°ì§€ ë° 'ì•ˆì „í•˜ê²Œ' ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  els.font.addEventListener("change", () => {
    // 1. ì¼ë‹¨ ë°˜ì‘ì„ ë³´ì—¬ì£¼ê¸° ìœ„í•´ ë°”ë¡œ ê·¸ë¦½ë‹ˆë‹¤.
    render();

    // 2. ë¸Œë¼ìš°ì €ì—ê²Œ "ì´ í°íŠ¸ ì¤€ë¹„ ë‹¤ ëë‹ˆ?" í™•ì¸í•©ë‹ˆë‹¤.
    const fontStr = "60px " + els.font.value;
    
    document.fonts.load(fontStr).then(() => {
        // 3. ë¡œë”©ì´ ëë‚¬ë‹¤ëŠ” ì‹ í˜¸ê°€ ì˜¤ë©´ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
        render();
        
        // [ì¶”ê°€ëœ ì•ˆì „ì¥ì¹˜] 
        // ì‚¬ëŒ ëˆˆë³´ë‹¤ ì•„ì£¼ ì¡°ê¸ˆ ëŠ¦ê²Œ(0.05ì´ˆ ë’¤) í•œ ë²ˆ ë” í™•ì‹¤í•˜ê²Œ ë§ê·¸ë¦½ë‹ˆë‹¤.
        // (ë°˜ë°˜ ì„ì´ëŠ” 'ê¹œë¹¡ì„' í˜„ìƒì„ ë®ì–´ì¤ë‹ˆë‹¤)
        setTimeout(render, 50);
    });
  });

  /* 3. ì´ˆê¸° ì‹¤í–‰ (í™”ë©´ ì¼œì§€ìë§ˆì ì‹¤í–‰ë˜ëŠ” ê³³) */
  // ê¸°ë³¸ê°’ ë¬¸êµ¬ëŠ” ì—¬ê¸°ì„œ ë”± í•œ ë²ˆë§Œ ì„¤ì •!
  els.text.value = "ì‚¬ë‘í•˜ëŠ” ìš°ë¦¬ ì•„ë“¤,ë”¸\në§¤ì¼ë§¤ì¼ ì‘ì›í•´\nì˜¤ëŠ˜ ì €ë…ì€ ì¹˜í‚¨ì´ë‹¤\nì‹ ë‚˜ê²Œ ë†€ì";
 // â­ í•µì‹¬ ìˆ˜ì •: í°íŠ¸ê°€ ë‹¤ ë¡œë”©ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ê°€ ê·¸ë¦¬ê¸°
  document.fonts.ready.then(() => {
    render();
  });
})();
</script>
</body>
</html>

